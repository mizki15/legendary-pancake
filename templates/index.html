from flask import Flask, request, send_file, render_template
import io
import csv
import os
from dotenv import load_dotenv
import requests
from datetime import datetime
import time
import zoneinfo
import unicodedata

# .env読み込み
load_dotenv()

app = Flask(__name__)

youbi_list = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"]
JST = zoneinfo.ZoneInfo("Asia/Tokyo")


# -------------------------
# 共通ユーティリティ
# -------------------------

def normalize_text(text: str) -> str:
    """全角・半角・空白・英数字を完全正規化"""
    if not text:
        return ""
    return unicodedata.normalize("NFKC", text).strip()


def convert_date_to_slash_format(date_str):
    """YYYYMMDD または YYYY/MM/DD → YYYY/MM/DD"""
    if not date_str:
        return None
    date_str = normalize_text(date_str)
    if "/" in date_str and len(date_str) == 10:
        return date_str
    try:
        return datetime.strptime(date_str, "%Y%m%d").strftime("%Y/%m/%d")
    except ValueError:
        return None


# -------------------------
# 楽天API
# -------------------------

def get_data_from_api(facility_num):
    """施設番号のみを信頼して楽天APIから取得"""
    time.sleep(0.1)

    app_id = os.getenv("RAKUTEN_APP_ID")
    affiliate_id = os.getenv("RAKUTEN_AFFILIATE_ID")

    if not app_id or not affiliate_id:
        return {"error": "APIキーが設定されていません"}

    url = "https://app.rakuten.co.jp/services/api/Travel/SimpleHotelSearch/20170426"
    params = {
        "format": "json",
        "responseType": "large",
        "hotelNo": facility_num,
        "applicationId": app_id,
        "affiliateId": affiliate_id,
    }

    try:
        r = requests.get(url, params=params, timeout=10)
        r.raise_for_status()
        data = r.json()

        hotel = data["hotels"][0]["hotel"]
        basic = hotel[0]["hotelBasicInfo"]
        detail = hotel[2]["hotelDetailInfo"]

        return {
            "施設番号": facility_num,
            "施設名": normalize_text(basic["hotelName"]),
            "都道府県コード": detail["middleClassCode"],
            "市区町村コード": detail["smallClassCode"],
        }

    except Exception as e:
        return {"error": f"APIエラー: {e}"}


# -------------------------
# CSV生成
# -------------------------

def make_row_list_from_dict(d):
    return [
        d.get("施設番号", ""),
        d.get("施設名", ""),
        d.get("都道府県コード", ""),
        d.get("市区町村コード", ""),
        "",
        d.get("販売期間(from)", ""),
        d.get("販売期間(to)", ""),
        d.get("出発期間(from)", ""),
        d.get("出発期間(to)", ""),
        d.get("発空港", ""),
        d.get("参加人数オプション", ""),
        d.get("時間", ""),
        d.get("時間", ""),
        d.get("曜日", ""),
        d.get("粗利率1", ""),
        d.get("粗利率2", ""),
        d.get("粗利率3", ""),
        "Ａ",
    ]


def transform_data_for_csv(data_dict):
    errors = []
    warnings = []

    facilities_raw = data_dict["施設番号"].splitlines()
    rate_lines_raw = data_dict["出発期間+粗利率"].splitlines()

    rate_lines = []
    for line in rate_lines_raw:
        parts = normalize_text(line).split()
        if len(parts) == 5:
            rate_lines.append(parts)
        elif line.strip():
            errors.append(f"出発期間+粗利率の形式が不正: {line}")

    hanbai_from = convert_date_to_slash_format(data_dict["販売期間(from)"])
    hanbai_to = convert_date_to_slash_format(data_dict["販売期間(to)"])

    if not hanbai_from or not hanbai_to:
        errors.append("販売期間の日付形式が不正です")

    if data_dict["参加人数オプション"] not in ["1", "2"]:
        errors.append("参加人数オプションが未選択です")

    if errors:
        return {"error": "\n".join(errors)}

    rows = []

    for line in facilities_raw:
        line = normalize_text(line)
        if not line:
            continue

        # ★ ここが最重要：1回だけ分割
        try:
            facility_num, input_name = line.split(None, 1)
        except ValueError:
            errors.append(f"施設番号と施設名の形式が不正: {line}")
            continue

        api_data = get_data_from_api(facility_num)
        if "error" in api_data:
            errors.append(api_data["error"])
            continue

        # 名称不一致は警告扱い
        if normalize_text(input_name) != api_data["施設名"]:
            warnings.append(
                f"名称差異: 入力='{input_name}' / API='{api_data['施設名']}'"
            )

        for rate in rate_lines:
            dep_from = convert_date_to_slash_format(rate[0])
            dep_to = convert_date_to_slash_format(rate[1])
            if not dep_from or not dep_to:
                errors.append(f"出発期間の日付形式が不正: {rate[0]} {rate[1]}")
                continue

            base = api_data.copy()
            base.update({
                "販売期間(from)": hanbai_from,
                "販売期間(to)": hanbai_to,
                "出発期間(from)": dep_from,
                "出発期間(to)": dep_to,
                "発空港": data_dict["発空港"],
                "参加人数オプション": data_dict["参加人数オプション"],
                "粗利率1": rate[2],
                "粗利率2": rate[3],
                "粗利率3": rate[4],
                "時間": datetime.now(JST).strftime("%Y/%m/%d %H:%M:%S"),
            })

            for youbi in youbi_list:
                tmp = base.copy()
                tmp["曜日"] = youbi
                rows.append(make_row_list_from_dict(tmp))

    if errors:
        return {"error": "\n".join(errors)}

    return {
        "rows": rows,
        "warnings": warnings
    }


# -------------------------
# Flask
# -------------------------

@app.route("/")
def index():
    return render_template("index.html")


@app.route("/convert", methods=["POST"])
def convert():
    data_dict = {
        "出発期間+粗利率": request.form.get("departure_rate", ""),
        "施設番号": request.form.get("facility", ""),
        "販売期間(from)": request.form.get("sale_from", ""),
        "販売期間(to)": request.form.get("sale_to", ""),
        "発空港": request.form.get("airport", ""),
        "参加人数オプション": request.form.get("participants", ""),
    }

    result = transform_data_for_csv(data_dict)

    if "error" in result:
        return f"<h1>エラー</h1><pre>{result['error']}</pre>", 400

    output = io.StringIO()
    writer = csv.writer(output, quoting=csv.QUOTE_ALL)
    for row in result["rows"]:
        writer.writerow(row)

    output.seek(0)

    return send_file(
        io.BytesIO(output.getvalue().encode("utf-8-sig")),
        mimetype="text/csv",
        as_attachment=True,
        download_name="converted.csv",
    )


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
